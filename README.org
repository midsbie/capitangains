#+title: CapitaNGains - Capital Gains Tool for IBKR Statements
#+options: toc:t num:nil

CapitaNGains generates capital gains reports from broker annual statements. It is designed for Portuguese tax residents and currently supports Interactive Brokers (IBKR) Activity Statement CSV exports. The tool creates an XLSX workbook with realized trades (FIFO), symbol summaries, dividends, account interest, SYEP interest, withholding tax, and an Annex-G helper sheet in Portuguese or English.

* Disclaimer

This software is experimental and *may produce inconsistent or invalid results*. Always verify figures against broker statements and applicable tax rules. FX conversions rely on provided data and approximations and may differ from broker or tax authority calculations. *No warranty or tax advice is provided*.

* Features

- FIFO realized gains with buy-lot audit trail.
- Optional EUR conversion per date using an external FX table.
- Output sheets: Trading Totals, Realized Trades, Per Symbol Summary, Dividends, Account Interest, SYEP Interest, Withholding Tax, Lot-Level EUR Breakdown.

* Installation

1. Clone the repository
   git clone [[https://github.com/midsbie/capitangains.git][https://github.com/midsbie/capitangains.git]]

2. Create a virtual environment
   #+begin_src sh
   cd capitangains
   python3 -m venv .venv
   source .venv/bin/activate
   #+end_src

3. Install dependencies
   #+begin_src sh
   make setup
   #+end_src

* CLI Usage

Pass one or more CSV files as arguments. Include prior years so FIFO can match sales with earlier buys. If sales reference missing buys, the tool aborts unless auto-fix is enabled. Output defaults to =report_<year>.xlsx= in the current directory.

** Examples
- Single year:
  #+begin_src sh
    python -m capitangains.cmd \
           --year 2024 \
           --output ./report_2024.xlsx \
           --fx-table ./fx_rates.csv \
           --locale EN \
           ./U1234567_2024_2024.csv
  #+end_src

- Multi-year:
  #+begin_src sh
    python -m capitangains.cmd \
           --year 2024 \
           --output ./report_2024.xlsx \
           --fx-table ./fx_rates.csv \
           --locale EN \
           ./U1234567_2023_2023.csv ./U1234567_2024_2024.csv
  #+end_src

** Handling unmatched SELLs

By default, the tool aborts on unmatched SELLs. With =--auto-fix-sell-gaps=, it synthesizes residual lots using IBKR per-trade /Basis/ values. Synthetic legs are marked in the Realized Trades sheet for auditability. If Basis is missing or inconsistent, zero-cost allocation is applied with logged warnings.

* FX Data

EUR conversion requires a CSV with columns: =date=, =currency=, =rate=. Rate is expressed as target currency units per EUR. The tool computes EUR per unit and applies fallback to prior dates when exact rates are missing. Compatible datasets can be extracted from Banco de Portugal using [[https://github.com/midsbie/bdpfxtract/][bdpfxtract]].

* Notes

- Input must be an Activity Statement CSV from IBKR, not Flex queries
- Missing or elided values are treated as zero with warnings
- SYEP totals rows are ignored; per-day details are included

* License
MIT license, see LICENSE file.