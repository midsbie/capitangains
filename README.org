#+title: CapitanGains - Capital Gains Tool for IBKR Statements
#+options: toc:t num:nil

CapitanGains generates capital gains reports from broker annual statements. It is designed for Portuguese tax residents and currently supports Interactive Brokers (IBKR) Activity Statement CSV exports. The tool creates an XLSX workbook with realized trades (FIFO), per-symbol summaries, dividends, account and SYEP interest, withholding tax, stock transfers, and an Annex-J helper sheet (lot-level EUR breakdown) in Portuguese or English.

* Disclaimer

This software is experimental and *may produce inconsistent or invalid results*. Always verify figures against broker statements and applicable tax rules. FX conversions rely on provided data and approximations and may differ from broker or tax authority calculations. *No warranty or tax advice is provided*.

* Features

- FIFO realized gains with buy-lot audit trail.
- Optional EUR conversion per date using an external FX table.
- Output sheets: Trading Totals, Realized Trades, Per Symbol Summary, Dividends, Account Interest, SYEP Interest, Withholding Tax, Stock Transfers, Lot-Level EUR Breakdown (Annex J helper).

* Installation

1. Install [[https://docs.astral.sh/uv/][uv]]

2. Clone the repository
   #+begin_src sh
   git clone https://github.com/midsbie/capitangains.git
   cd capitangains
   #+end_src

3. Install dependencies
   #+begin_src sh
   make setup
   #+end_src

* CLI Usage

After installation, run the =capitangains= command. Pass one or more Activity Statement CSV files as arguments. Include prior years so FIFO can match sales with earlier buys. If sales reference missing buys, the tool aborts unless auto-fix is enabled. Output defaults to =report_<year>.xlsx= in the current directory.

** Examples
- Single year:
  #+begin_src sh
    capitangains \
        --year 2024 \
        --output ./report_2024.xlsx \
        --fx-table ./fx_rates.csv \
        --locale EN \
        ./U1234567_2024_2024.csv
  #+end_src

- Multi-year:
  #+begin_src sh
    capitangains \
        --year 2024 \
        --output ./report_2024.xlsx \
        --fx-table ./fx_rates.csv \
        --locale EN \
        ./U1234567_2023_2023.csv ./U1234567_2024_2024.csv
  #+end_src

You can also run the CLI module directly from the source checkout:

#+begin_src sh
  python -m capitangains.cmd ...
#+end_src

** Options

- =--year YYYY=: calendar year to report.
- =--fx-table PATH=: FX rates CSV (see FX Data section).
- =--locale {EN,PT}=: locale for sheet names and headers (default EN).
- =--output PATH=: output XLSX file path (default =report_<year>.xlsx=).
- =--auto-fix-sell-gaps=: synthesize residual lots when SELLS exceed available buys.
- =-v= / =-vv=: increase logging verbosity (INFO / DEBUG).

** Handling unmatched SELLs

By default, the tool aborts on unmatched SELLs. With =--auto-fix-sell-gaps=, it synthesizes residual lots using IBKR per-trade /Basis/ values. Synthetic legs are marked in the Realized Trades sheet for auditability. If Basis is missing or inconsistent, zero-cost allocation is applied with logged warnings.

* FX Data

EUR conversion requires a CSV with columns: =date=, =currency=, =rate=. Rate is expressed as target currency units per EUR. The tool computes EUR per unit and applies fallback to prior dates when exact rates are missing. Compatible datasets can be extracted from Banco de Portugal using [[https://github.com/midsbie/bdpfxtract/][bdpfxtract]].

* Notes

- Input must be an Activity Statement CSV from IBKR, not Flex queries
- Missing or elided values are treated as zero with warnings
- SYEP totals rows are ignored; per-day details are included

* License
MIT license, see LICENSE file.
